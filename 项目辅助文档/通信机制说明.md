# 前端与Eagle插件通信机制说明

## 概述

Eagle Ontology Manager 是一个独立的网页应用，通过运行在Eagle内部的插件作为数据桥接来获取Eagle中的数据。

根据架构设计，Eagle软件和FastAPI是两个独立的实体，它们之间的通信完全由Eagle插件充当的中继站和后台同步服务来完成。

## 通信架构

```
┌─────────────────┐               ┌────────────────────┐               ┌──────────────┐
│   前端应用      │               │ Eagle插件(桥接)    │               │   Eagle应用  │
│ (独立网页)      │               │ (运行在Eagle内部)  │               │              │
└─────────────────┘               └────────────────────┘               └──────────────┘
         ▲                                  │                                     ▲
         │                                  │                                     │
         │                           eagle.api 调用                        eagle.api
         │                                  ▼                                     │
         │                       ┌────────────────────┐                          │
         │                       │  Eagle 数据源      │◄─────────────────────────┘
         │                       └────────────────────┘
         │                                  │
         │                           HTTP POST (客户端)
         │                                  ▼
         │                       ┌────────────────────┐
         │                       │   FastAPI 后端     │
         │                       │   (数据大脑)       │
         │                       └────────────────────┘
         │                                │      ▲
         │                         ORM/SQL│      │
         │                                ▼      │
         │                       ┌────────────────────┐
         │                       │   数据库           │
         │                       │ (PostgreSQL/SQLite)│
         │                       └────────────────────┘
         │                                │
         └────────────────────────────────┘

┌─────────────────┐
│   外部网页      │
│   (浏览器)      │
└─────────────────┘
         │
    HTTP GET 请求
         ▼
┌────────────────────┐
│   FastAPI 后端     │
│   (数据入口)       │
└────────────────────┘
         │
    查询数据库
         ▼
┌────────────────────┐
│   数据库           │
│ (已同步的Eagle数据)│
└────────────────────┘
```

## 角色与边界

| 组件 | 核心职责 | 环境/边界 |
|------|----------|-----------|
| Eagle 软件 | 数据源。提供素材、标签、星级等原始数据 | 运行在应用沙箱内，数据无法被外部直接访问 |
| Eagle 插件 | 数据中继（唯一的出口）。负责获取 Eagle 实时数据并转发 | 运行在 Eagle 内置的 JS 运行时环境，具有调用 eagle.api 的特殊权限，但不能作为 HTTP 服务器 |
| FastAPI 后端 | 数据大脑 & 业务核心。负责数据持久化、认证、业务逻辑 | 独立运行的 Python 进程 (HTTP 服务器)，监听端口，与 Eagle 无直接关系 |

## 通信机制详解

### 1. 数据提取：Eagle插件 → Eagle软件

**机制**：eagle.api 调用
插件调用 Eagle 软件暴露的原生 API（如 eagle.api.getItems），从沙箱内部获取最新的素材数据。

**示例**：
```javascript
// 在Eagle插件中
const items = await eagle.api.getItems();
```

### 2. 数据转发：Eagle插件 → FastAPI后端

**机制**：HTTP POST (客户端行为)
插件利用其 JS 环境的 fetch 或 XMLHttpRequest，将获取到的数据封装成 JSON，作为 HTTP 客户端发送给 FastAPI 的 /api/v1/sync 接口。

**示例**：
```javascript
// 在Eagle插件中
fetch('http://localhost:8000/api/v1/sync', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    items: eagleItems,
    timestamp: Date.now()
  })
});
```

### 3. 数据持久化：FastAPI → 数据库

**机制**：ORM/SQL
FastAPI 接收到数据后，进行校验、清洗，并写入到 PostgreSQL/SQLite 数据库中。

**示例**：
```python
# 在FastAPI后端中
@app.post("/api/v1/sync")
async def sync_eagle_data(data: SyncData):
    # 数据校验和清洗
    # 写入数据库
    return {"status": "success"}
```

### 4. 外部网页访问数据

外部网页（如Chrome浏览器中的Vue应用）需要读取Eagle数据时，完全绕过Eagle插件：

1. 外部网页 → FastAPI 后端：发送 HTTP GET 请求（例如 /api/v1/images）
2. FastAPI 后端 → 数据库：查询已同步的 Eagle 数据副本
3. FastAPI 后端 → 外部网页：返回数据，完成渲染

**示例**：
```javascript
// 在前端应用中
const response = await fetch('http://localhost:8000/api/v1/images');
const images = await response.json();
```

## 开发与部署流程

### 开发阶段
1. 启动FastAPI后端服务（模拟数据同步和存储功能）
2. 启动前端开发服务器
3. 在前端应用中请求数据并展示

### 部署阶段
1. 将前端应用部署为独立网页
2. 部署FastAPI后端服务
3. 将插件安装到Eagle应用中
4. Eagle插件定期同步数据到FastAPI后端
5. 前端通过HTTP请求从FastAPI后端获取数据

## 故障排除

### Eagle插件无法同步数据
1. 检查Eagle插件是否正常运行在Eagle中
2. 检查Eagle API调用是否成功
3. 检查网络连接和FastAPI后端是否可访问

### 前端无法获取数据
1. 检查FastAPI后端是否正常运行
2. 检查数据库中是否有同步的数据
3. 检查前端网络连接

## 总结

关键原则：
1. Eagle软件与FastAPI后端之间没有直接通信
2. Eagle插件是Eagle数据的唯一搬运工
3. FastAPI是所有数据（无论是来自Eagle还是自定义业务逻辑）的唯一访问入口
4. 前端应用作为独立网页，只能通过FastAPI后端访问数据