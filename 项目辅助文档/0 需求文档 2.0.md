# Eagle Ontology Manager 2.0 需求文档

最后更新：2025-11-15 (已定义核心数据模型和API契约)

## 一、项目概述

### 1.1 项目背景

Eagle Ontology Manager 1.0 版本作为一个 Eagle 插件，实现了基础的图像属性管理和可视化功能。随着用户需求的增长和技术的发展，我们需要一个更加完整和现代化的架构来支持更复杂的功能。

2.0 版本将采用前后端分离的架构，引入数据库持久化存储，提供更强大的用户管理、数据同步和可视化分析功能。

### 1.2 项目目标

构建现代化的全栈应用架构

实现用户认证和权限管理

提供稳定可靠的后端 API 服务

增强数据持久化和同步能力

支持更复杂的可视化分析功能

提供 Docker 部署方案，便于本地和局域网部署

## 二、系统架构

### 2.1 整体架构图

┌────────────────────────────────────────────────────────────┐
│                     用户界面层                              │
├────────────────────────────────────────────────────────────┤
│  ┌─────────────┐        ┌──────────────┐                   │
│  │   Web UI    │◄──────►│  Eagle插件   │                   │
│  │ (Vue3)      │        │ (前端桥接)   │                   │
└──┴─────────────┴────────┴──────────────┴───────────────────┘
                    │              │
            HTTP API Calls   PostMessage API
                    │              │
┌───────────────────▼──────────────▼──────────────────────────┐
│                     应用服务层                              │
├────────────────────────────────────────────────────────────┤
│  ┌─────────────┐   ┌──────────────┐    ┌─────────────────┐  │
│  │  RESTful    │   │   用户认证   │    │  数据同步服务   │  │
│  │   API       │   │   模块       │    │     模块        │  │
│  │ (FastAPI)   │   │              │    │                 │  │
└──┴─────────────┴───┴──────────────┴────┴─────────────────┴──┘
                    │         │                   │
              ORM Calls   JWT Auth          Eagle API
                    │         │                   │
┌───────────────────▼─────────▼───────────────────▼──────────┐
│                     数据存储层                              │
├────────────────────────────────────────────────────────────┤
│  ┌─────────────┐        ┌──────────────┐                   │
│  │   用户数据   │       │   图像数据    │                   │
│  │   数据库     │       │   数据库      │                   │
│  │ (PostgreSQL) │       │ (SQLite)     │                   │
└──┴─────────────┴───────┴──────────────┴───────────────────┘




### 2.2 目录结构

项目根目录/
├── frontend/                # Vue3 前端
│     ├── src/
│     └── dist/
│
├── backend/                 # FastAPI (Python) 后端
│     ├── app/
│     │    ├── auth/        # 登录、注册、JWT
│     │    ├── users/       # 用户信息
│     │    ├── eagle/       # 对接 Eagle 数据的 API
│     │    ├── logs/        # 操作记录
│     │    └── database/
│     └── main.py
│
├── eagle-plugin/            # 背景服务插件
│     ├── manifest.json
│     └── main.js           # 监听请求，调用 Eagle API
│
├── db/                      # PostgreSQL / SQLite
│     └── init.sql
│
└── docker-compose.yml        # 局域网部署（选配）







## 三、功能模块详细设计

### 3.1 前端模块 (frontend/)

#### 3.1.1 技术栈

框架：Vue 3 (Composition API)

状态管理：Pinia

路由：Vue Router

UI组件库：Element Plus

构建工具：Vite

可视化：D3.js

#### 3.1.2 功能列表

用户登录/注册界面

图像属性管理仪表板

属性层级可视化展示

数据表格编辑界面

数据导出功能（CSV/JSON）

用户设置和偏好配置

操作日志查看

### 3.2 后端模块 (backend/)

#### 3.2.1 技术栈

框架：FastAPI (Python)

数据库：PostgreSQL (用户数据) + SQLite (图像数据)

ORM：SQLAlchemy

认证：JWT (使用 fastapi-users 库实现)

API文档：Swagger UI

#### 3.2.2 功能列表

认证模块 (auth/)

用户注册

用户登录

JWT Token 管理

密码重置

Session 管理

用户模块 (users/)

用户信息管理

权限控制

用户偏好设置

用户操作日志

Eagle对接模块 (eagle/)

Eagle数据同步API

属性映射接口

数据导入/导出接口

批量操作接口

日志模块 (logs/)

操作日志记录

系统日志管理

日志查询接口

数据库模块 (database/)

数据库连接管理

数据模型定义

数据迁移脚本

### 3.3 Eagle插件模块 (eagle-plugin/)

#### 3.3.1 功能列表

与Eagle应用通信桥接

调用Eagle API获取数据

将数据发送到后端服务

接收后端指令并执行操作

用户界面集成

#### 3.3.2 通信机制

使用PostMessage API与前端通信

通过HTTP请求与后端通信

实时数据同步机制

### 3.4 数据库模块 (db/)

#### 3.4.1 PostgreSQL (用户数据)

用户信息表

权限表

操作日志表

系统配置表

#### 3.4.2 SQLite (图像数据)

图像元数据表

属性结构表

属性值表

同步状态表

### 3.5 数据模型初步设计 (已完善核心模型)

此章节定义了核心表的字段、数据类型和关系，以便开始数据库设计和 ORM 建模。

模型名称

存储数据库

关键字段 (字段名: 类型)

描述

User

PostgreSQL

id: UUID, email: String, password_hash: String, is_active: Boolean, role_id: Integer (外键)

用户认证信息，由 fastapi-users 定义核心结构。

Role

PostgreSQL

id: Integer, name: String

定义系统中的用户角色（Admin, User, Viewer, Guest...）。

ImageSyncStatus

SQLite

id: Integer (主键), eagle_id: String (唯一ID), last_sync_time: Timestamp, user_id: UUID (外键), status: String

图像同步控制点。 仅存储 Eagle ID、最后同步时间、关联用户ID和同步状态，用于实现增量同步。

AttributeStructure

SQLite

id: Integer (主键), name: String, type: Enum (TEXT/NUMBER/DATE/SELECT/MULTI), options: JSON, parent_id: Integer (自引用), user_id: UUID (外键)

属性结构的层级定义（本体论）。 type 字段决定前端渲染和后端验证方式，options 用于单选/多选的预设值。

ImageAttributeValue

SQLite

id: Integer (主键), eagle_id: String (外键), attribute_id: Integer (外键), value_json: JSON

图像和属性值的实际关联数据。 使用 eagle_id 关联图像；value_json 存储属性的实际值，以支持各种类型（字符串、数字、数组等）。

### 3.6 API 接口契约概要 (已完善核心接口)

此章节定义了核心 API 的输入和输出，以便前后端并行开发。

模块

功能

路径 (示例)

HTTP 方法

请求体/查询参数

响应数据

Auth

登录

/auth/jwt/login

POST

Request Body: {"username": "string", "password": "string"}

Response Body: {"access_token": "jwt_token", "token_type": "bearer"}

Eagle

同步数据 (增量)

/api/v1/sync

POST

Request Body: {"library_id": "string", "updates": [{"eagle_id": "string", "action": "ADD/DELETE/UPDATE", ...}]}

Response Body: {"status": "success", "processed_count": 10}

Eagle

获取图像数据

/api/v1/images

GET

Query Params: page: int, limit: int, filters: json_string (包含属性值过滤条件)

Response Body: {"total": 500, "pages": 50, "data": [{"eagle_id": "string", "attributes": [{"name": "string", "value": "any"}]}]}

Attribute

获取属性结构 (层级)

/api/v1/attributes

GET

Query Params: user_id: uuid (可选)

Response Body: [{"id": 1, "name": "Style", "type": "SINGLE_SELECT", "options": [...], "children": [...]}] (层级结构列表)

Attribute

批量更新值

/api/v1/values/batch

PUT

Request Body: {"updates": [{"eagle_id": "string", "attribute_id": 5, "value": "new value"}]}

Response Body: {"status": "success", "updated_count": 10}

## 四、部署方案

### 4.1 本地开发环境

使用Docker Compose一键启动所有服务

支持热重载开发模式

提供Mock数据用于前端开发

### 4.2 生产部署

Docker容器化部署

支持Nginx反向代理

数据库持久化存储

日志管理

### 4.3 局域网部署

提供docker-compose.yml配置文件

支持多用户访问

数据本地存储，保障隐私安全

## 五、开发路线图

阶段一：基础架构搭建 (1-2周)

$$$$

 创建项目目录结构

$$$$

 搭建后端基础框架 (FastAPI)

$$$$

 实现用户认证模块

$$$$

 创建前端项目框架 (Vue 3, Pinia, Element Plus)

$$$$

 实现Eagle插件基础通信

阶段二：核心功能开发 (3-6周)

$$$$

 实现图像数据同步功能

$$$$

 开发属性管理界面

$$$$

 实现数据导入/导出功能

$$$$

 完善用户权限管理

$$$$

 实现基础可视化功能 (D3.js)

阶段三：增强功能开发 (7-10周)

$$$$

 开发高级可视化分析

$$$$

 实现批量操作功能

$$$$

 完善日志系统

$$$$

 优化性能和用户体验

$$$$

 编写完整测试用例

阶段四：测试与部署 (11-12周)

$$$$

 进行全面测试

$$$$

 修复发现的问题

$$$$

 编写部署文档

$$$$

 发布稳定版本

六、技术规范

6.1 代码规范

前端采用ESLint + Prettier规范代码风格

后端采用相应语言的代码规范 (Python PEP 8)

所有接口遵循RESTful设计原则

数据库设计遵循第三范式

6.2 安全规范

用户密码加密存储

JWT Token安全传输

API接口权限验证

SQL注入防护

XSS攻击防护

6.3 性能规范

前端资源压缩打包

后端接口响应时间控制在200ms以内

数据库查询优化

支持缓存机制

七、未来扩展方向

集成AI图像识别功能，自动标注图像属性

支持多平台客户端（桌面端、移动端）

实现团队协作功能

提供插件市场，支持第三方插件扩展

集成更多可视化分析工具

支持多语言国际化