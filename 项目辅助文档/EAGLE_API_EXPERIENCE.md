# Eagle API 使用经验总结

## 1. API调用基础

### 1.1 基本原则
- 必须使用官方文档定义的标准方法（如`eagle.item.get({})`），禁止使用非文档化方法（如`eagle.getAllItems`）
- 调用时必须显式指定所需字段（如preview、folders、tags），否则可能返回不完整数据
- 所有数据操作需通过`eagle.item`命名空间下的标准API进行

### 1.2 常用字段
```javascript
["id", "name", "url", "folders", "tags", "annotation", "lastModified", "thumbnailURL", "thumbnailPath"]
```

## 2. 数据处理要点

### 2.1 文件夹处理
- 文件夹和标签信息为独立结构，需在API请求中声明获取，并通过ID映射转换为用户可读名称
- items中的folders字段是文件夹ID数组，需通过`eagle.library.info()`获取完整文件夹结构并映射路径

### 2.2 图片预览处理
- 优先级：thumbnailURL → thumbnailPath → url
- 需添加错误处理显示占位符

## 3. 数据同步机制

### 3.1 同步原则
- 修改后的项目数据必须通过`item.save()`方法写回Eagle，禁止直接修改本地资源文件
- 实现变更检测时应保存原始数据快照，仅同步实际修改的字段以提高效率
- 同步完成后需刷新界面并重置状态标识

### 3.2 支持修改的属性
- name
- tags
- folders
- annotation

## 4. 双向映射机制

### 4.1 文件夹映射
- 实现数据同步时，除构建从文件夹ID到名称的映射外，还需建立反向映射机制，以便将用户输入的文件夹路径转换为Eagle内部使用的ID
- 对于支持编辑的字段（如文件夹、标签、注释等），必须确保前端展示值与后端存储ID之间的可逆转换

## 5. 可编辑字段同步

### 5.1 同步逻辑
- 所有需支持修改的字段在UI组件中应配置为可编辑模式
- 同步逻辑需检测所有可编辑字段的变化，而不仅限于基础属性
- 修改检测应基于原始数据快照，仅提交实际变更的数据以提升性能

## 6. Tabulator 编辑器问题

### 问题描述
在使用 Tabulator 表格组件时，遇到了 [cellEdited](file:///Users/dengbowen/Documents/Piceable/js/modules/ui.js#L143-L154) 事件未触发的问题，导致无法自动检测用户对表格数据的修改。

### 解决方案
实现了自定义编辑器，确保在用户完成编辑操作后能正确触发同步。

## 7. 原始项目对象方法丢失问题

### 问题描述
在存储原始项目数据时，使用了 `Object.assign({}, item)` 创建副本，这种方法会丢失原始对象的方法，包括用于保存数据的 `save()` 方法，导致在同步时出现 "originalItem.save is not a function" 错误。

### 解决方案
直接存储原始项目对象而不是创建副本，确保保留所有方法和属性。

## 8. 文件夹同步问题

### 问题描述
当用户输入一个新的文件夹路径（如"灯/黄铜"）时，我们的代码尝试在 `window.folderIdMap` 中查找这个路径对应的 ID，但因为这是一个新路径，`window.folderIdMap` 中没有这个映射关系，所以返回了 undefined，导致文件夹更新失败。

### 解决方案
实现了一个完整的文件夹处理机制：
1. 首先尝试在现有文件夹映射中查找
2. 如果找不到，则尝试创建新文件夹（支持根文件夹和子文件夹）
3. 更新全局文件夹映射表以供后续使用

## 9. 重复创建文件夹问题

### 问题描述
在处理文件夹创建时，可能会重复创建同名的文件夹。

### 解决方案
引入 `window.createdFolders` 映射来跟踪已经创建的文件夹，避免重复创建。

## 10. 多文件夹支持

### 特性说明
Eagle 支持将一个项目添加到多个文件夹中。我们的插件完全支持这一特性。

### 实现方式
1. **数据显示**：在表格中，项目所属的多个文件夹以逗号分隔的形式显示（例如："文件夹1, 文件夹2, 文件夹3"）
2. **数据编辑**：用户可以通过在文件夹列中输入逗号分隔的文件夹名称来指定项目所属的多个文件夹
3. **数据同步**：
   - 解析用户输入的逗号分隔的文件夹名称
   - 将每个文件夹名称转换为对应的文件夹 ID
   - 将项目分配给所有指定的文件夹
   - 支持混合已存在和新创建的文件夹

### 使用方法
1. 在文件夹列中点击要编辑的单元格
2. 输入文件夹名称，多个文件夹用逗号分隔（例如："灯, 桌, 装饰"）
3. 按 Enter 键或点击其他地方保存更改
4. 系统将自动将项目添加到所有指定的文件夹中

### 注意事项
- 系统会自动识别已存在的文件夹，避免重复创建
- 如果输入的文件夹名称不存在，系统会尝试创建新文件夹
- 支持创建嵌套文件夹（例如："主文件夹/子文件夹"）
- 父文件夹必须存在才能创建子文件夹

## 11. 手动同步机制

### 特性说明
用户可以通过点击"同步到Eagle"按钮手动触发数据同步。

### 实现方式
1. 用户在表格中编辑数据
2. 点击"同步到Eagle"按钮触发同步
3. 系统会自动检测修改并同步到Eagle

### 优势
- 提供明确的同步控制
- 用户可以确认修改后再同步
- 避免频繁自动同步可能带来的性能问题

## 12. 调试与验证策略

### 12.1 日志记录
- 在关键流程节点添加DEBUG日志，覆盖数据获取、转换、渲染全过程
- 构建"请求→响应→映射→渲染"端到端验证链条，逐阶段确认数据完整性

### 12.2 环境检测
- 实现环境检测机制，区分Eagle运行环境与普通浏览器环境
- 非Eagle环境下提供模拟数据支持调试

## 13. 架构设计规范

### 13.1 三层分离架构
- 前端UI
- 数据处理
- Eagle桥接

### 13.2 核心模块
- 文件读取
- 属性映射
- 表格展示
- 同步
- 导出
- 配置

### 13.3 数据加载流程
遵循"API获取→格式转换→本地缓存→界面渲染"的数据加载流程

## 14. 第三方库兼容性与版本管理

### 14.1 兼容性问题
- 即使代码中不直接使用已废弃的API（如`navigator.userAgent`），所依赖的第三方库可能仍会使用，导致浏览器警告或未来兼容性问题

### 14.2 版本管理建议
- 遇到由第三方库引起的兼容性警告时，优先检查是否有更新版本解决了相关问题
- 建议定期审查和更新项目依赖，尤其是主要UI库（如Tabulator）
- 引入外部库时应记录其版本和潜在兼容性问题
- 对于通过CDN加载的库，应明确版本号以便追踪和升级