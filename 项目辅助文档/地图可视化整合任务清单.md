# 地图可视化功能整合任务清单

## 任务概述
将代迁移目录中的palladio-lite-map地图可视化功能整合到Piceable项目中，增强项目的数据可视化能力。

## 任务状态
- **创建日期**: 2023-11-15
- **负责人**: 开发团队
- **当前状态**: 进行中

## 需要迁移的功能

### 1. 数据管理与可视化功能
- [x] 实现数据过滤系统（基于搜索和分类的双重过滤）
- [ ] 添加分组可视化功能（按特定列分组显示数据）
- [ ] 实现分类颜色映射系统
- [ ] 添加分类项显示控制功能（可隐藏/显示特定分类项）

### 2. 交互功能
- [x] 实现记录选择和悬停状态管理
- [x] 添加全文搜索功能
- [x] 实现侧边栏控制功能
- [x] 添加多语言支持（目标语言切换）
- [x] 实现地图图层切换功能

### 3. 高级功能
- [x] 实现书签管理功能（添加、更新、删除书签）
- [x] 实现标注功能（添加、编辑、删除标注）
- [x] 添加标注模式开关
- [x] 实现视图状态保存功能
- [x] 实现关系列自动检测功能

### 4. UI组件
- [x] 实现信息弹出卡片组件
- [x] 实现标注表单组件
- [x] 拆分图层切换器为独立组件
- [x] 拆分语言切换器为独立组件
- [x] 拆分标签显示开关为独立组件
- [ ] 实现侧边栏面板组件

### 5. 数据处理
- [x] 集成CSV解析器
- [ ] 实现AI翻译服务
- [ ] 完善数据过滤逻辑

### 6. 状态管理
- [x] 实现Vue3组合式API的状态管理
- [x] 添加状态持久化功能
- [x] 确保响应式数据流

### 7. 数据源集成
- [ ] 与现有项目的数据模型对接
- [ ] 支持从后端获取数据
- [ ] 实现多数据源支持（CSV上传、Eagle同步等）

## 实施步骤

### 阶段一：基础架构准备
- [x] 创建地图状态管理store（使用Pinia）
- [x] 添加必要的依赖（Leaflet, @vue-leaflet/vue-leaflet等）
- [x] 创建基础地图组件骨架
- [x] 集成到现有路由系统
- [x] 添加导航菜单项

### 阶段二：数据模型与状态管理
- [x] 定义地图相关数据类型（DataRecord, Annotation等）
- [x] 创建地图状态管理模块（Pinia store）
- [x] 实现状态持久化（localStorage）
- [x] 实现数据过滤逻辑
- [x] 实现分类颜色映射系统

### 阶段三：核心功能实现
- [x] 实现记录选择和悬停交互
- [x] 添加全文搜索功能
- [ ] 实现分组可视化功能
- [ ] 添加分类项显示控制
- [ ] 实现书签管理功能
- [ ] 实现标注功能

### 阶段四：UI组件开发
- [x] 开发信息弹出卡片组件（PopupCard.vue）
- [x] 开发标注表单组件（AnnotationForm.vue）
- [ ] 实现侧边栏面板
- [x] 添加地图图层切换控件（LayerSwitcher.vue）
- [x] 添加语言切换控件（LanguageSwitcher.vue）
- [x] 添加标签显示开关控件（LabelToggle.vue）
- [ ] 实现多语言支持界面

### 阶段五：数据集成与服务
- [ ] 实现CSV文件上传和解析服务（csvParser.ts）
- [ ] 与后端API集成获取数据
- [ ] 实现Eagle数据同步支持
- [ ] 添加AI翻译服务（aiService.ts）
- [ ] 实现地图数据服务（mapDataService.ts）
- [ ] 实现标注服务（annotationService.ts）
- [ ] 实现书签服务（bookmarkService.ts）

### 阶段六：测试与优化
- [ ] 编写单元测试
- [ ] 进行功能测试
- [ ] 优化性能
- [ ] 修复已知问题
- [ ] 编写文档

## 风险与注意事项

### 技术风险
- [x] Vue与React组件兼容性问题：palladio-lite-map使用React，需适配Vue3
- [x] 状态管理差异：React Context API与Vue Pinia的转换
- [x] 类型定义不一致：需重新定义TypeScript接口

### 解决方案
- [x] 使用Vue3组合式API重写关键功能
- [x] 将React Context转换为Pinia store
- [x] 根据项目规范重新定义TypeScript接口

### 注意事项
- 保持与现有UI风格一致
- 遵循项目代码规范
- 确保与现有状态管理系统的兼容性
- 注意性能优化，特别是大数据量时的渲染性能

## 组件拆分与服务封装规划

### 主要组件对应关系

| 代迁移项目文件 | 现有项目对应位置 | 说明 |
|----------------|----------------|------|
| MapView.tsx | [MapView.vue](file:///Users/ug/Documents/产业图谱/Piceable/frontend/src/views/MapView.vue) | 主地图视图组件，作为容器组件，负责协调子组件和状态管理 |
| PopupCard.tsx | components/map/PopupCard.vue | 信息弹出卡片组件，用于展示记录、标注和搜索结果详细信息 |
| AnnotationForm.tsx | components/map/AnnotationForm.vue | 标注表单组件，用于创建和编辑地图标注 |
| LayerSwitcher | components/map/LayerSwitcher.vue | 地图图层切换控件，提供多种底图风格选择 |
| LanguageSwitcher | components/map/LanguageSwitcher.vue | 语言切换控件，支持多语言显示 |
| LabelToggle | components/map/LabelToggle.vue | 标签显示开关，控制地图上的文字标签显示 |

### 服务封装规划

1. **mapStore.ts** - 已实现
   - 位置: `/Users/ug/Documents/产业图谱/Piceable/frontend/src/stores/map.ts`
   - 职责: 集中管理地图全局状态，包含数据、筛选条件、视图状态等

2. **csvParser.ts** - 待实现
   - 位置: `/Users/ug/Documents/产业图谱/Piceable/frontend/src/services/csvParser.ts`
   - 职责: 解析上传的CSV文件，自动检测经纬度列，数据预处理

3. **aiService.ts** - 待实现
   - 位置: `/Users/ug/Documents/产业图谱/Piceable/frontend/src/services/aiService.ts`
   - 职责: 封装Gemini API调用，提供多语言翻译功能，处理API密钥和错误情况

4. **mapDataService.ts** - 待实现
   - 位置: `/Users/ug/Documents/产业图谱/Piceable/frontend/src/services/mapDataService.ts`
   - 职责: 与后端API通信获取项目数据，数据格式转换，缓存管理

5. **annotationService.ts** - 待实现
   - 位置: `/Users/ug/Documents/产业图谱/Piceable/frontend/src/services/annotationService.ts`
   - 职责: 标注的CRUD操作，本地存储持久化，数据验证

6. **bookmarkService.ts** - 待实现
   - 位置: `/Users/ug/Documents/产业图谱/Piceable/frontend/src/services/bookmarkService.ts`
   - 职责: 书签的CRUD操作，本地存储持久化，视图状态保存