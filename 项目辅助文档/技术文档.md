# 技术文档

## 项目概述

Eagle Ontology Manager 是一个基于本体论的Eagle资源管理工具，旨在提供更加智能和结构化的资源管理方式。

这是一个独立的网页应用，通过运行在Eagle内部的插件作为数据桥接从Eagle中读取数据并在前端展示。

## 技术架构

### 整体架构图

```
┌─────────────────┐               ┌────────────────────┐               ┌──────────────┐
│   前端应用      │               │ Eagle插件(桥接)    │               │   Eagle应用  │
│ (独立网页)      │               │ (可启动HTTP服务)   │               │              │
└─────────────────┘               └────────────────────┘               └──────────────┘
         ▲                                  │                                     ▲
         │                                  │                                     │
         │                           eagle.api 调用                        eagle.api
         │                                  ▼                                     │
         │                       ┌────────────────────┐                          │
         │                       │  Eagle 数据源      │◄─────────────────────────┘
         │                       └────────────────────┘
         │                                  │
         │                           HTTP服务(实时数据)
         │                                  ▼
         │                       ┌────────────────────┐
         │                       │   FastAPI 后端     │
         │                       │   (用户管理等)     │
         │                       └────────────────────┘
         │                                │      ▲
         │                         ORM/SQL│      │
         │                                ▼      │
         │                       ┌────────────────────┐
         │                       │   数据库           │
         │                       │ (PostgreSQL/SQLite)│
         │                       └────────────────────┘
         │                                │
         └────────────────────────────────┘

┌─────────────────┐
│   外部网页      │
│   (浏览器)      │
└─────────────────┘
         │
    HTTP 请求
         ▼
┌────────────────────┐
│   FastAPI 后端     │
│   (用户管理等)     │
└────────────────────┘
         │
    查询数据库
         ▼
┌────────────────────┐
│   数据库           │
│ (用户数据等)       │
└────────────────────┘
```

### 角色与边界

| 组件 | 核心职责 | 环境/边界 |
|------|----------|-----------|
| Eagle 软件 | 数据源。提供素材、标签、星级等原始数据 | 运行在应用沙箱内，数据无法被外部直接访问 |
| Eagle 插件 | 数据中继和服务提供者。负责获取 Eagle 实时数据并提供HTTP服务 | 运行在 Eagle 内置的 Node.js 环境，具有调用 eagle.api 的特殊权限，可启动 HTTP 服务器 |
| FastAPI 后端 | 用户管理、权限控制、数据持久化等核心业务功能 | 独立运行的 Python 进程 (HTTP 服务器)，监听端口 |
| 前端应用 | 独立网页应用。负责数据展示和用户交互 | 运行在浏览器中，通过 HTTP 与 Eagle 插件和 FastAPI 后端通信 |

### 目录结构

```
项目根目录/
├── frontend/                # Vue3 前端（独立网页应用）
│     ├── src/
│     └── dist/
│
├── backend/                 # FastAPI (Python) 后端（用户管理等核心业务）
│     ├── app/
│     │    ├── auth/        # 登录、注册、JWT
│     │    ├── users/       # 用户信息
│     │    ├── eagle/       # 对接 Eagle 数据的 API
│     │    ├── logs/        # 操作记录
│     │    └── database/
│     └── main.py
│
├── eagle-plugin/            # Eagle插件（数据桥接和服务提供者）
│     ├── manifest.json
│     └── main.js           # 启动 HTTP 服务，调用 Eagle API
│
├── db/                      # PostgreSQL / SQLite
│     └── init.sql
│
├── 项目辅助文档/             # 项目文档
│   ├── 0 需求文档 2.0.md    # 需求文档
│   ├── 技术文档.md           # 技术文档
│   ├── 开发计划清单.md        # 开发计划清单
│   ├── 通信机制说明.md        # 通信机制说明
│   └── 迁移计划/            # 迁移计划
├── docker-compose.yml        # 局域网部署（选配）
└── README.md                # 项目说明文档
```

## 前端技术栈（独立网页应用）

### 框架和工具

- **框架**：Vue 3 (Composition API)
- **状态管理**：Pinia
- **路由**：Vue Router
- **UI组件库**：Element Plus
- **构建工具**：Vite
- **可视化**：D3.js

### 功能模块

1. **用户登录/注册界面**
2. **图像属性管理仪表板**
3. **属性层级可视化展示**
4. **数据表格编辑界面**
5. **数据导出功能（CSV/JSON）**
6. **用户设置和偏好配置**
7. **操作日志查看**

## 后端技术栈（用户管理等核心业务）

### 框架和工具

- **框架**：FastAPI (Python)
- **数据库**：PostgreSQL (用户数据) + SQLite (图像数据)
- **ORM**：SQLAlchemy
- **认证**：JWT (使用 fastapi-users 库实现)
- **API文档**：Swagger UI

### 功能模块

#### 认证模块 (auth/)
- 用户注册
- 用户登录
- JWT Token 管理
- 密码重置
- Session 管理

#### 用户模块 (users/)
- 用户信息管理
- 权限控制
- 用户偏好设置
- 用户操作日志

#### Eagle对接模块 (eagle/)
- Eagle数据同步API
- 属性映射接口
- 数据导入/导出接口
- 批量操作接口

#### 日志模块 (logs/)
- 操作日志记录
- 系统日志管理
- 日志查询接口

#### 数据库模块 (database/)
- 数据库连接管理
- 数据模型定义
- 数据迁移脚本

## Eagle插件模块（数据桥接和服务提供者）

### 功能列表

1. **启动HTTP服务**：使用Node.js的http模块启动本地HTTP服务器
2. **调用Eagle API获取数据**：使用eagle.api获取Eagle数据
3. **提供RESTful API接口**：为前端应用提供实时Eagle数据访问接口
4. **数据处理和转发**：处理前端请求并返回相应数据

### 技术栈

- **运行环境**：Eagle内置的Node.js环境
- **网络通信**：Node.js http模块
- **数据处理**：JavaScript/Node.js原生功能

### API接口设计

#### 数据相关

- **GET /api/v1/items** - 获取项目列表
- **GET /api/v1/item/:id** - 获取单个项目
- **PUT /api/v1/item/:id** - 更新项目
- **POST /api/v1/sync** - 同步数据
- **POST /api/v1/export** - 导出数据

#### 系统相关

- **GET /api/v1/library** - 获取库信息
- **GET /api/v1/health** - 健康检查

## 数据库设计

### PostgreSQL (用户数据)

- 用户信息表
- 权限表
- 操作日志表
- 系统配置表

### SQLite (图像数据)

- 图像元数据表
- 属性结构表
- 属性值表
- 同步状态表

## 通信机制

### 1. 前端应用 → Eagle插件（HTTP请求，实时Eagle数据）

前端应用通过HTTP请求与Eagle插件通信获取实时Eagle数据：

```javascript
// 在前端应用中
const response = await fetch('http://localhost:3001/api/v1/items');
const items = await response.json();
```

### 2. 前端应用 → FastAPI后端（HTTP请求，用户数据等）

前端应用通过HTTP请求与FastAPI后端通信获取用户数据等：

```javascript
// 在前端应用中
const response = await fetch('http://localhost:8000/api/v1/users/profile');
const user = await response.json();
```

### 3. Eagle插件 → Eagle软件（eagle.api调用）

Eagle插件通过eagle.api调用获取Eagle数据：

```javascript
// 在Eagle插件中
const items = await eagle.api.getItems();
```

### 4. 数据流向

```
┌─────────────────┐    HTTP请求    ┌────────────────────┐    Eagle API    ┌──────────────┐
│   前端应用      │ ────────────► │ Eagle插件          │ ──────────────► │   Eagle应用  │
│ (独立网页)      │ ◄──────────── │ (HTTP服务)         │ ◄────────────── │              │
│                 │   实时数据    │ (处理请求并返回)   │   返回数据      │              │
└─────────────────┘               └────────────────────┘                 └──────────────┘
         ▲                                  │
         │                           HTTP服务(用户数据)
         │                                  ▼
         │                       ┌────────────────────┐
         │                       │   FastAPI 后端     │
         │                       │   (用户管理等)     │
         │                       └────────────────────┘
         │                                │      ▲
         │                         ORM/SQL│      │
         │                                ▼      │
         │                       ┌────────────────────┐
         │                       │   数据库           │
         │                       │ (PostgreSQL/SQLite)│
         │                       └────────────────────┘
         │                                │
         └────────────────────────────────┘

┌─────────────────┐
│   外部网页      │
│   (浏览器)      │
└─────────────────┘
         │
    HTTP 请求
         ▼
┌────────────────────┐
│   FastAPI 后端     │
│   (用户管理等)     │
└────────────────────┘
         │
    查询数据库
         ▼
┌────────────────────┐
│   数据库           │
│ (用户数据等)       │
└────────────────────┘
```

## 部署方案

### 开发阶段

1. 启动FastAPI后端服务：
   ```bash
   cd backend
   pip install -r requirements.txt
   python main.py
   ```

2. 启动前端开发服务器：
   ```bash
   cd frontend
   npm run dev
   ```

3. 在Eagle中加载并运行插件

4. 前端应用通过`http://localhost:3001/api/v1/...`访问插件提供的实时数据API
5. 前端应用通过`http://localhost:8000/api/v1/...`访问后端提供的用户管理API

### 生产部署

1. 构建前端应用：
   ```bash
   cd frontend
   npm run build
   ```

2. 部署FastAPI后端服务
3. 将构建结果部署到Web服务器
4. 将插件安装到Eagle应用中
5. 前端应用通过HTTP请求与插件和后端服务通信