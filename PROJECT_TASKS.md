# 项目任务清单 - 创建项目功能

## 功能概述
实现"创建项目"按钮功能，提供两种创建方式：
1. 用户上传 CSV 或 JSON 文件
2. 从 Eagle 同步数据

## 当前Eagle数据同步功能分析

经过查看代码发现，TablePage已经实现了与Eagle插件的数据同步功能：

1. **通信模块** (`pluginCommunication.ts`):
   - 提供了与Eagle插件通信的HTTP API接口
   - 实现了获取库信息、项目列表、单个项目以及更新项目的API
   - 支持通过`getItems()`获取Eagle项目数据

2. **数据处理** (`useItems.ts`):
   - 使用`useItems` composable管理项目数据
   - 实现了`refreshData()`方法从Eagle获取最新数据
   - 提供了`saveItemChanges()`方法保存项目更改
   - 通过`setCommunication()`设置通信方式为HTTP API

3. **页面展示** (`TablePage.vue`):
   - 在组件挂载时调用`refreshData()`加载数据
   - 使用`ItemTable`组件展示数据
   - 提供了编辑功能和详情面板

## 任务清单

### 前端实现
- [x] 在 HomePage 添加"创建项目"弹窗
- [x] 将弹窗组件化，移至独立组件文件
- [x] 实现文件上传功能（支持 CSV/JSON 格式）
- [x] 修改TablePage逻辑，根据数据源加载数据
- [x] 添加路由跳转逻辑到 TablePage
- [x] 修复路由导入错误
- [x] 分离上传文件和Eagle同步的数据源
- [x] 改进CSV文件处理，支持智能字段映射
- [x] 完善字段映射功能，确保必填字段验证
- [x] 改进ID自动生成逻辑
- [x] 修改ID字段为非必填
- [x] 实现项目管理功能（显示项目列表、创建项目等）

### 后端实现
- [x] 创建项目数据存储接口
- [x] 实现文件上传处理接口
- [x] 修复后端服务启动问题
- [x] 实现 Eagle 数据同步接口
- [x] 数据库存储用户项目数据
- [x] 实现项目管理接口
- [x] 修复后端服务路由问题
- [x] 实现获取当前用户信息接口

### 集成测试
- [x] 测试文件上传流程
- [ ] 测试 Eagle 数据同步流程
- [ ] 验证数据正确存储
- [ ] 验证页面跳转和数据渲染
- [ ] 测试项目管理功能

## 详细设计

### 弹窗设计
1. 弹窗标题："创建新项目"
2. 两个选项按钮：
   - "上传文件" - 支持 CSV/JSON 格式
   - "从 Eagle 同步" - 调用 Eagle 插件 API
3. 取消按钮

### 文件上传流程
1. 用户点击"上传文件"
2. 显示文件选择对话框
3. 用户选择 CSV 或 JSON 文件
4. 前端验证文件格式
5. 发送文件到后端处理接口
6. 后端存储数据到用户数据库
7. 跳转到 TablePage 显示数据

### Eagle 同步流程
1. 用户点击"从 Eagle 同步"
2. 调用 Eagle 插件 API 获取数据
3. 将数据发送到后端存储接口
4. 后端存储数据到用户数据库
5. 跳转到 TablePage 显示数据

## CSV处理改进

### 组合方案实现
1. **提供标准模板**：
   - 在上传界面提供下载标准CSV模板的链接
   - 模板包含所有必需字段和示例数据

2. **智能识别**：
   - 实现自动字段映射功能，支持常见表头的自动识别
   - 通过模糊匹配算法识别不同命名方式的字段

3. **手动映射**：
   - 当自动识别失败时，提供字段映射界面
   - 用户可以通过界面选择每个系统字段对应CSV中的哪一列
   - 完善必填字段验证，确保关键字段（如名称）正确映射

## ID自动生成

### 实现方案
1. **前端自动生成**：
   - 当CSV文件中没有提供ID字段或ID字段为空时，前端自动生成唯一ID
   - ID格式：`item_{timestamp}_{index}`，确保唯一性

2. **后端兼容处理**：
   - 后端接受无ID或空ID的数据
   - 前端确保在上传前所有项目都有有效ID

## 必填字段设置

### 当前必填字段
1. **名称**（name）：项目显示名称，必须提供
2. **ID**：已改为非必填，系统支持自动生成

## 数据库存储用户项目数据

### 当前实现分析
通过查看代码发现，当前系统已经实现了基本的数据库存储功能，但缺少用户项目数据的隔离存储：

1. **数据库结构**：
   - 系统使用SQLite或PostgreSQL数据库（根据配置）
   - 已有用户表（users）存储用户信息
   - 已有项目表（items）存储项目数据
   - 已有库信息表（library_info）存储库信息

2. **当前问题**：
   - 所有用户共享同一个项目表，没有用户项目数据隔离
   - 上传的项目数据没有与特定用户关联
   - 无法区分哪些项目属于哪个用户

### 实现思路

#### 方案一：添加用户ID字段（已实现）
1. **数据库修改**：
   - 在items表中添加user_id字段，关联users表
   - 在library_info表中添加user_id字段，关联users表

2. **后端修改**：
   - 在上传接口中获取当前用户信息
   - 在保存项目数据时关联用户ID
   - 在查询项目数据时按用户ID过滤

3. **前端修改**：
   - 在请求中传递用户信息（通过JWT token）
   - 确保只显示当前用户的项目数据

#### 方案二：创建独立的用户项目表
1. **数据库修改**：
   - 创建user_projects表存储用户与项目的关联关系
   - 创建user_libraries表存储用户与库的关联关系

2. **后端修改**：
   - 通过关联表查询和存储用户项目数据
   - 实现更复杂的权限控制

3. **前端修改**：
   - 与方案一类似

#### 推荐实现步骤
1. **数据库结构修改**：
   - 在items表中添加user_id字段
   - 在library_info表中添加user_id字段
   - 添加外键约束

2. **后端API修改**：
   - 修改上传接口，添加用户认证和数据关联
   - 修改查询接口，按用户ID过滤数据
   - 修改更新接口，确保只能更新当前用户的数据

3. **前端集成**：
   - 确保所有API请求都携带认证信息
   - 在UI中显示当前用户的项目数据

4. **数据迁移**：
   - 为现有数据添加默认用户关联（如admin用户）
   - 确保迁移过程不影响现有功能

### 技术细节

#### 数据库表结构修改
```sql
-- SQLite
ALTER TABLE items ADD COLUMN user_id INTEGER REFERENCES users(id);
ALTER TABLE library_info ADD COLUMN user_id INTEGER REFERENCES users(id);

-- PostgreSQL
ALTER TABLE items ADD COLUMN user_id INTEGER REFERENCES users(id);
ALTER TABLE library_info ADD COLUMN user_id INTEGER REFERENCES users(id);
```

#### 后端修改要点
1. 在API路由中添加用户认证依赖
2. 在CRUD操作中添加用户ID过滤条件
3. 在数据保存时关联当前用户ID

#### 前端修改要点
1. 确保所有请求都携带认证token
2. 在数据展示时只显示当前用户的数据

### 已完成的实现

1. **数据库结构修改**：
   - 在items表中添加了user_id字段，关联users表
   - 在library_info表中添加了user_id字段，关联users表
   - 添加了projects表用于存储用户项目信息

2. **后端API修改**：
   - 在所有项目相关接口中添加了用户认证依赖
   - 在CRUD操作中实现了按用户ID过滤数据
   - 在数据保存时关联当前用户ID

3. **前端集成**：
   - 系统通过JWT token自动传递用户信息
   - 所有API请求都携带认证信息
   - 数据展示时只显示当前用户的数据

## 项目管理功能

### 功能需求
1. 用户登录后能看到自己的项目列表
2. 项目列表显示项目名称和最后修改时间
3. 用户可以创建新项目
4. 用户可以删除项目
5. 用户可以进入项目查看和编辑项目数据

### 数据库设计
1. **projects表**：
   - id: 项目ID（主键）
   - name: 项目名称
   - created_at: 创建时间
   - last_modified: 最后修改时间
   - user_id: 用户ID（外键）
   - items_count: 项目中包含的项数

2. **items表**：
   - 添加project_id字段，关联projects表

3. **library_info表**：
   - 添加project_id字段，关联projects表

### API接口设计
1. **获取项目列表**：GET /api/projects
2. **获取单个项目**：GET /api/project/{project_id}
3. **创建项目**：POST /api/projects
4. **删除项目**：DELETE /api/project/{project_id}
5. **获取当前用户信息**：GET /api/auth/users/me

### 前端实现
1. 修改HomePage，从后端获取真实的项目列表
2. 实现创建项目功能
3. 实现项目跳转功能

### 已完成的实现
1. **数据库结构**：
   - 创建了projects表存储项目信息
   - 在items表和library_info表中添加了project_id字段

2. **后端API**：
   - 实现了项目的增删查接口
   - 实现了用户认证和数据隔离
   - 实现了获取当前用户信息接口

3. **前端实现**：
   - 修改了HomePage，从后端获取真实的项目列表
   - 实现了创建项目功能
   - 实现了项目跳转功能

## 后端服务修复

### 问题分析
在实现项目管理功能时，发现后端服务存在以下问题：
1. 路由注册不完整，缺少项目管理相关路由
2. 模型导入错误，缺少必要的数据模型定义
3. 数据库表结构变更后未正确处理
4. 服务启动时端口冲突

### 修复措施
1. 修复路由注册，确保所有API路由正确包含
2. 补充缺失的数据模型定义（Token、UserInDB等）
3. 重新初始化数据库，确保表结构正确
4. 解决端口冲突问题，确保服务正常启动

### 已完成的修复
1. [x] 修复路由注册问题
2. [x] 补充缺失的数据模型
3. [x] 重新设计数据库表结构
4. [x] 解决服务启动问题
5. [x] 实现获取当前用户信息接口

## 登录功能修复

### 问题分析
登录页面在获取用户信息时出现404错误，经过检查发现：
1. 后端API路径正确，但前端请求路径有误
2. 登录成功后获取用户信息的API路径不正确

### 修复措施
1. 修正前端登录页面中获取用户信息的API路径
2. 确保登录流程完整正确

### 已完成的修复
1. [x] 修复前端登录页面API路径问题
2. [x] 验证登录功能正常工作

## 用户认证系统修复

### 问题分析
在用户注册和登录过程中发现以下问题：
1. 用户注册时出现服务器内部错误（500）
2. 登录时出现认证失败（401）
3. 检查发现是由于模型属性命名不一致导致的问题

### 修复措施
1. 统一用户模型中的属性命名（使用下划线命名法）
2. 修复用户CRUD操作中的属性引用问题
3. 确保前后端数据模型一致性

### 已完成的修复
1. [x] 修复用户模型属性命名不一致问题
2. [x] 修复用户CRUD操作中的属性引用问题
3. [x] 验证用户注册和登录功能正常工作